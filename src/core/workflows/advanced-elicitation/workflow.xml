<task id="_bmad/core/workflows/advanced-elicitation/workflow.xml" name="Advanced Elicitation" standalone="true"
  methods="{project-root}/_bmad/core/workflows/advanced-elicitation/methods.csv"
  category-metadata="{project-root}/_bmad/core/workflows/advanced-elicitation/category-metadata.csv"
  categories-dir="{project-root}/_bmad/core/workflows/advanced-elicitation/categories"
  agent-party="{project-root}/_bmad/_config/agent-manifest.csv">
  <llm critical="true">
    <i>MANDATORY: Execute ALL steps in the flow section IN EXACT ORDER</i>
    <i>DO NOT skip steps or change the sequence</i>
    <i>HALT immediately when halt-conditions are met</i>
  </llm>

  <integration description="When called from workflow">
    <i>1. Check if a category file was passed as parameter</i>
    <i>2. If category provided: use methods from that category file</i>
    <i>3. If no category: read category-metadata.csv, detect context and suggest appropriate categories</i>
    <i>4. Apply elicitation methods to enhance current content</i>
    <i>5. Return enhanced version when user selects 'x'</i>
  </integration>

  <parameters>
    <param name="category" optional="true">
      <desc>Path to category-specific EA file (generated during installation)</desc>
      <example>{{categories-dir}}/sanity.md</example>
    </param>
  </parameters>

  <data-sources description="Read these files to understand available categories">
    <source file="{{category-metadata}}" purpose="Category names, descriptions, when to use, and file names"/>
    <source file="{{methods}}" purpose="Full method definitions when needed"/>
  </data-sources>

  <flow>
    <step n="1" title="Category Detection and Method Loading">
      <if category="provided">
        <action>Load the category file passed as parameter</action>
        <announce>"Using methods from: [category_file_name]"</announce>
      </if>

      <if category="not provided">
        <action>Read {{category-metadata}} to get list of available categories</action>

        <context-detection>
          <i>Analyze conversation context and match with category when_to_use field:</i>
          <i>- Output review/finalization → sanity, anti-bias</i>
          <i>- Requirements/PRD work → collaboration, core</i>
          <i>- Architecture/technical → technical, risk</i>
          <i>- Brainstorming/ideation → creative, collaboration</i>
          <i>- Decision making → risk, challenge, core</i>
          <i>- Post-project → retrospective</i>
          <i>- Complex reasoning → advanced</i>
          <i>- Stress-testing → competitive</i>
        </context-detection>

        <present-categories>
          "Select a category or use full library:

          **Recommended for current context:**
          [1-3 most relevant categories based on when_to_use matching]

          **All categories:** (from category-metadata.csv)
          [List each category with icon and display_name]

          [f] Full library (all methods from methods.csv)
          [x] Skip elicitation"
        </present-categories>

        <action>When user selects category, load file from {{categories-dir}}/[file_name]</action>
      </if>

      <action>Load {{agent-party}} for Party Mode integration if active</action>
    </step>

    <step n="2" title="Present Methods and Handle Responses">
      <format>
        **Advanced Elicitation** | [Category Name] | [N] methods

        Choose a number (1-5), [r] Reshuffle, [c] Change category, or [x] Proceed:

        1. [Method Name] - [brief description]
        2. [Method Name] - [brief description]
        3. [Method Name] - [brief description]
        4. [Method Name] - [brief description]
        5. [Method Name] - [brief description]

        r. Show 5 different methods from this category
        c. Change to different category
        x. Proceed / Complete elicitation
      </format>

      <response-handling>
        <case n="1-5">
          <i>Execute the selected method using its description and pattern</i>
          <i>Apply the method to the current content being enhanced</i>
          <i>Display the enhanced version</i>
          <i>CRITICAL: Ask user if they would like to apply changes (y/n) and HALT</i>
          <i>CRITICAL: If Yes, apply. If No, discard.</i>
          <i>CRITICAL: Re-present the menu</i>
        </case>
        <case n="r">
          <i>Reshuffle: Select 5 different methods from current category</i>
        </case>
        <case n="c">
          <i>Return to step 1 category selection</i>
        </case>
        <case n="x">
          <i>Complete elicitation and return to calling workflow</i>
        </case>
        <case n="multiple-numbers">
          <i>Execute methods in sequence, then re-offer choices</i>
        </case>
      </response-handling>
    </step>

    <step n="3" title="Execution Guidelines">
      <i>Method execution: Use the description to understand and apply each method</i>
      <i>Output pattern: Use as flexible guide (e.g., "paths → evaluation → selection")</i>
      <i>Stay relevant: Tie elicitation to specific content being analyzed</i>
      <i>Identify personas: For multi-persona methods, use party members if available</i>
      <i>Critical loop: Always re-offer choices after each method execution</i>
      <i>Continue until user selects 'x'</i>
    </step>
  </flow>
</task>
